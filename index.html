<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <script src="http://d3js.org/d3.v5.min.js" language="JavaScript"></script>
    <style></style>
</head>
<body onload="init()">
    <h1>Hello, World</h1>
    <p>I removed all rows with NA data.</p>
    <p>Maximum sales price is an outlier at $185 million. I removed this data point. Next highest is 3.6 million</p>
    <p>Converted exact date to months-since-start-date (1998-12-30)</p>
    <input type="range" name="mySlider" id=mySlider min="0" max="223" value="184" step="1" list="steplist" onchange="updateSliderText(this.value);">
    <datalist id="steplist">
        <option>1</option>
        <!--<option>4</option>
        <option>16</option>
        <option>28</option>
        <option>40</option>
        <option>52</option>
        <option>64</option>
        <option>76</option>
        <option>88</option>
        <option>100</option>
        <option>112</option>
        <option>124</option>
        <option>136</option>
        <option>148</option>
        <option>160</option>
        <option>172</option>-->
        <option>184</option>
        <!--<option>196</option>
        <option>208</option>-->
        <option>222</option>
    </datalist> 
    <p id="sliderText">May 2014: Month after start of Flint water crisis</p>
    <svg width=1920 height=1080></svg>
    <script>

        var data = null;
        var priceGraph = null;
        var selectedMonth = 184;
        var svgHeight = 500;
        var svgWidth = 1000;
        
        //https://stackoverflow.com/questions/17226576/creating-a-text-labeled-x-axis-with-an-ordinal-scale-in-d3-js   
        var yScale = d3.scalePow().exponent(0.5).domain([300000,0]).range([0,svgHeight]); //price
        var xScale = d3.scalePow().exponent(0.5).domain([0,50000]).range([0,svgWidth]); //distance
        
        function filterByMonth(d){
            return parseInt(d.Month) === selectedMonth;
        }
        
        async function init(){
            data = await d3.csv("https://raw.githubusercontent.com/kalinalinkalina/flint/master/data/flint_months_noNAs_noExpectedLead.csv");
            priceGraph = d3.select("svg")
                .append("g")
                .attr("transform","translate(80,50)");
            
            drawChart();
            
            // Add axes
            d3.select("svg")
                .append("g")
                .attr("transform", "translate(80,50)")
                .call(d3.axisLeft(yScale));
            d3.select("svg")
                .append("g")
                    .attr("transform", "translate(80,550)")
                    .call(d3.axisBottom(xScale));
            
            // Add axes labels
            d3.select("svg")
                .append("text")
                .attr("class", "x label")
                .attr("text-anchor", "end")
                .attr("x", svgWidth / 2 + 80)
                .attr("y", svgHeight + 100)
                .text("Distance to Affected Boundary (m)");
            d3.select("svg")
                .append("text")
                .attr("class", "y label")
                .attr("text-anchor", "end")
                .attr("y", 0)
                .attr("x", -svgHeight/2 + 80)
                .attr("dy", ".75em")
                .attr("transform", "rotate(-90)")
                .text("Sales Price of House ($)");
                
            
        }

        
        async function drawChart(){
            
            var data_month = await data.filter(filterByMonth);
            
            // Update data
            bars = priceGraph
                .selectAll("rect")
                .data(data_month);
            
            // Add bars for new data
            bars
                .enter()
                .append("rect")
                    .attr("x", function(d,i){return xScale(d.DistToBoundary);})
                    .attr("y", function(d,y){return yScale(d.SalesPrice);})
                    .attr("width", 2)
                    .attr("height", function(d,i){return svgHeight-yScale(d.SalesPrice)});
            
            // Update old bars in same place
            bars
                .transition().duration(250)
                .attr("y", function(d,y){return yScale(d.SalesPrice);})
                .attr("height", function(d,i){return svgHeight-yScale(d.SalesPrice)});
            
            
            // Remove old bars
            bars
                .exit()
                .remove();
                
            /*
            priceGraph
                .transition()
                .duration(1000)
                .attr("y", function(d,y){return yScale(d.SalesPrice);})
                .attr("height", function(d,i){return svgHeight-yScale(d.SalesPrice)});
                */
        }
        
        // Listen to the slider?
        d3.select("#mySlider").on("change", function(d){
            selectedMonth = parseInt(this.value);
            drawChart();
        });
        
        function updateSliderText(val){
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            var startDate = new Date(1998, 12, 12);
            var monthsSinceStart = parseInt(val);
            var currentDate = new Date(startDate.setMonth(startDate.getMonth()+monthsSinceStart));
            var dateString = monthNames[currentDate.getMonth()] + " " + currentDate.getFullYear();
            document.getElementById('sliderText').innerHTML = dateString; 
        }
        
    </script>
</body>
</html>
