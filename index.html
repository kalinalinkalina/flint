<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <script  type="text/javascript" src="libs/d3.v5.min.js"></script>
    <script type="text/javascript" src="libs/topojson.v3.min.js"></script> 
    <style></style>
</head>
<body onload="init()">
    <h1>Hello, World</h1>
    <p>I removed all rows with NA data.</p>
    <p>Maximum sales price is an outlier at $185 million. I removed this data point. Next highest is 3.6 million</p>
    <p>Converted exact date to months-since-start-date (1998-12-30)</p>
    
    <div id="tooltip" style="opacity:0; position:absolute; background: white;"></div>
    
    <svg id="map" width=1280 height=600></svg>
    
    <h2 id="leadSliderText">April 2015</h2><br/>
    <svg id="colorbar" width=500 height=30></svg><br/>
    <input type="range" name="leadSlider" id="leadSlider" min="195" max="223" value="223" step="1"  onchange="updateLeadSliderText(this.value);" style="width: 500px;"><br/>
    <svg id="bar_leadxprice" width=1280 height=600></svg><br/>
    
    
    <h2 id="distanceSliderText">May 2014: Start of Flint water crisis</h2><br/>
    <input type="range" name="distanceSlider" id="distanceSlider" min="0" max="223" value="184" step="1" list="steplist" onchange="updateDistanceSliderText(this.value);" style="width: 500px;">
    <datalist id="steplist">
        <option value="1">1</option>
        <option value="184">184</option>
        <option value="222">222</option>
    </datalist> <br/>
    <svg id="bar_distxprice" width=1280 height=600>
        <text x="1085" y="113" fill="#fdb130">May 2014: Start of crisis</text>
    </svg>
    <script>

        var data = null;
        var distanceGraph = null;
        var leadGraph = null;
        var mapChart = null;
        var selectedMonthDist = 184;
        var selectedMonthLead = 223;
        var svgHeight = 500;
        var svgWidth = 1000;
        
        var plasmaLead = d3.scaleSequential().domain([195,223]).interpolator(d3.interpolatePlasma);
        var plasmaDist = d3.scaleSequential().domain([1,223]).interpolator(d3.interpolatePlasma);
        
        //https://stackoverflow.com/questions/17226576/creating-a-text-labeled-x-axis-with-an-ordinal-scaleDist-in-d3-js   
        var yScaleDist = d3.scalePow().exponent(0.5).domain([300000,0]).range([0,svgHeight]); //price
        var yScaleLead = d3.scalePow().exponent(0.5).domain([3000000,0]).range([0,svgHeight])
        var xScaleDist = d3.scalePow().exponent(0.5).domain([0,50000]).range([0,svgWidth]); //distance
        var xScaleLead = d3.scalePow().exponent(0.5).domain([0,0.65]).range([0,svgWidth]); //lead
        
        function filterByMonthDist(d){
            var month = parseInt(d.Month);
            return month === selectedMonthDist;
            //return (parseInt(d.Month) <= selectedMonthDist);
        }
        function filterByMonthLead(d){
            var month = parseInt(d.Month);
            //return month === selectedMonthLead;
            return (month >= 195 && month <= selectedMonthLead);
        }
        
        async function init(){
            data = await d3.csv("https://raw.githubusercontent.com/kalinalinkalina/flint/master/data/flint_months_noNAs_noExpectedLead.csv");
            
            ////////////////// Draw Distance vs Price bar chart //////////////////
            distanceGraph = d3.select("#bar_distxprice")
                .append("g")
                .attr("transform","translate(80,50)");
            
            drawDistanceChart();
            
            // Add axes
            d3.select("#bar_distxprice")
                .append("g")
                .attr("transform", "translate(80,50)")
                .call(d3.axisLeft(yScaleDist));
            d3.select("#bar_distxprice")
                .append("g")
                    .attr("transform", "translate(80,550)")
                    .call(d3.axisBottom(xScaleDist));
            
            // Add axes labels
            d3.select("#bar_distxprice")
                .append("text")
                .attr("class", "x label")
                .attr("text-anchor", "end")
                .attr("x", svgWidth / 2 + 80)
                .attr("y", svgHeight + 90)
                .text("Distance to Water Pipe Boundary (m)");
            d3.select("#bar_distxprice")
                .append("text")
                .attr("class", "y label")
                .attr("text-anchor", "end")
                .attr("y", 0)
                .attr("x", -svgHeight/2 + 80)
                .attr("dy", ".75em")
                .attr("transform", "rotate(-90)")
                .text("Sales Price of House ($)");
            ////////////////////////////////////////////////////////////////////////
            
            ////////////////// Draw Lead vs Price bar chart //////////////////
            var colorBar = d3.select("#colorbar")
                .selectAll("rect")
                .data(d3.range(195,223), function(d) { return d; })
                .enter()
                .append("rect")
                .attr("x", function(d,i){return 500/(223-195) * i;})
                .attr("y", 0)
                .attr("height", 50)
                .attr("width", 500)
                .style("fill", function(d,i){return plasmaLead(d);})
            
            leadGraph = d3.select("#bar_leadxprice")
                .append("g")
                .attr("transform","translate(80,50)");
            
            drawLeadChart();
            
            // Add axes
            d3.select("#bar_leadxprice")
                .append("g")
                .attr("transform", "translate(80,50)")
                .call(d3.axisLeft(yScaleLead));
            d3.select("#bar_leadxprice")
                .append("g")
                    .attr("transform", "translate(80,550)")
                    .call(d3.axisBottom(xScaleLead));
            
            // Add axes labels
            d3.select("#bar_leadxprice")
                .append("text")
                .attr("class", "x label")
                .attr("text-anchor", "end")
                .attr("x", svgWidth / 2 + 80)
                .attr("y", svgHeight + 90)
                .text("Lead Level (Î¼g/L)");
            d3.select("#bar_leadxprice")
                .append("text")
                .attr("class", "y label")
                .attr("text-anchor", "end")
                .attr("y", 0)
                .attr("x", -svgHeight/2 + 80)
                .attr("dy", ".75em")
                .attr("transform", "rotate(-90)")
                .text("Sales Price of House ($)");
            
            
            
            ////////////////// Draw Map //////////////////
            
            d3.json("https://raw.githubusercontent.com/kalinalinkalina/flint/master/data/Michigan.geojson").then(function(bb){
            
            var projection = d3.geoAlbersUsa();
				   //.translate([svgWidth/2, svgHeight/2])    // translate to center of screen
				   //.scale([1000]);
            
            var path = d3.geoPath().projection(projection); 
            
            mapChart = d3.select("map")
                .append("g")
                .attr("transform", "translate(80,50)");
            
            mapChart
                .selectAll("path")
                .data(bb.coordinates)
                .join("path")
                .attr("d", path)
                .attr("fill", "#088")
                .attr("stroke", "#000");
                
            });
            
            
            
            //////////////////////////////////////////////
            
            
        }

        function addMarkers(){
            //data.forEach(function(d){
                //var marker = L.circleMarker([+d.Latitude, +d.Longitude]);
                //marker.addTo(map);
            //})
        }
        
        async function drawDistanceChart(){
            
            var div = d3.select("#tooltip");
            
            var data_month = await data.filter(filterByMonthDist);
            
            var dots = distanceGraph
                .selectAll("circle")
                .data(data_month);
            
            dots
                .enter()
                .append("circle")
                .attr("r", 3)
                .attr("cx", function(d,i){return xScaleDist(d.DistToBoundary);})
                .attr("cy", function(d,y){return yScaleDist(d.SalesPrice);})
                .on('mouseover', function (d, i) {
                    d3.select(this).transition()
                    .duration('50')
                    .attr('opacity', '.85');
                    //Makes the new div appear on hover:
                    div.transition()
                    .duration(50)
                    .style("opacity", 1);
                    let text = "Distance to Boundary: " + d.DistToBoundary + "<br/>Sales Price: " + d.SalesPrice;
                    div.html(text)
                        .style("left", (d3.event.pageX + 10) + "px")
                        .style("top", (d3.event.pageY - 15) + "px")
                })
                .on('mouseout', function (d, i) {
                    d3.select(this).transition()
                    .duration('50')
                    .attr('opacity', '1');
                    //Makes the new div disappear:
                    div.transition()
                    .duration('50')
                    .style("opacity", 0);
                });
                
            
            dots
                .transition().duration(30)
                .attr("cx", function(d,i){return xScaleDist(d.DistToBoundary);})
                .attr("cy", function(d,y){return yScaleDist(d.SalesPrice);});
            
            dots.exit().remove();
            
            
            // Draw regression line
            var lg = calcLinear(data_month, "DistToBoundary", "SalesPrice", d3.min(data_month, function(d){ return d.DistToBoundary}), d3.min(data_month, function(d){ return d.SalesPrice}));
            
            //await distanceGraph.selectAll("line").remove();
            
            var line = distanceGraph
                .append("line")
                .data(data_month)
                .attr("x1", xScaleDist(lg.ptA.x))
                .attr("y1", yScaleDist(lg.ptA.y))
                .attr("x2", xScaleDist(lg.ptB.x))
                .attr("y2", yScaleDist(lg.ptB.y))
                .style("stroke", function(d,i){return plasmaDist(d.Month);})
                .style("stroke-width", function(d,i){
                    if(d.Month == 184){
                        return 5;
                    }
                    return 1;
                });
            
        }
        
        async function drawLeadChart(){

            var div = d3.select("#tooltip");
            
            var data_month = await data.filter(filterByMonthLead);
            
            var dots = leadGraph
                .selectAll("circle")
                .data(data_month);
            
            dots
                .enter()
                .append("circle")
                //.attr("class", "dot")
                .attr("r", 3)
                .attr("cx", function(d,i){return xScaleLead(d.LeadLevel);})
                .attr("cy", function(d,i){return yScaleLead(d.SalesPrice);})
                .on('mouseover', function (d, i) {
                    d3.select(this).transition()
                    .duration('50')
                    .attr('opacity', '.85');
                    //Makes the new div appear on hover:
                    div.transition()
                    .duration(50)
                    .style("opacity", 1);
                    let text = "Lead Level: " + d.LeadLevel + "<br/>Sales Price: " + d.SalesPrice;
                    div.html(text)
                        .style("left", (d3.event.pageX + 10) + "px")
                        .style("top", (d3.event.pageY - 15) + "px")
                })
                .on('mouseout', function (d, i) {
                    d3.select(this).transition()
                    .duration('50')
                    .attr('opacity', '1');
                    //Makes the new div disappear:
                    div.transition()
                    .duration('50')
                    .style("opacity", 0);
                });
                
            dots
                .transition().duration(0)
                .attr("cx", function(d,i){return xScaleLead(d.LeadLevel);})
                .attr("cy", function(d,i){return yScaleLead(d.SalesPrice);});
            
            dots
                .exit()
                .remove();
            
            leadGraph
                //.update()
                .selectAll("circle")
                .style("fill", function(d,i){return plasmaLead(d.Month);});
        }
        
        // Listen to the sliders
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        
        d3.select("#distanceSlider").on("change", function(d){
            selectedMonthDist = parseInt(this.value);
            drawDistanceChart();
        });
        function updateDistanceSliderText(val){
            var startDate = new Date(1998, 12, 12);
            var monthsSinceStart = parseInt(val);
            var currentDate = new Date(startDate.setMonth(startDate.getMonth()+monthsSinceStart));
            var dateString = monthNames[currentDate.getMonth()] + " " + currentDate.getFullYear();
            document.getElementById('distanceSliderText').innerHTML = dateString; 
        }
        
        d3.select("#leadSlider").on("change", function(d){
            selectedMonthLead = parseInt(this.value);
            drawLeadChart();
        });
        function updateLeadSliderText(val){
            var startDate = new Date(1998, 12, 12);
            var monthsSinceStart = parseInt(val);
            var currentDate = new Date(startDate.setMonth(startDate.getMonth()+monthsSinceStart));
            var dateString = monthNames[currentDate.getMonth()] + " " + currentDate.getFullYear();
            document.getElementById('leadSliderText').innerHTML = dateString; 
        }
        
        
        
    // Returns an object with two points, where each point is an object with an x and y coordinate
    function calcLinear(data, x, y, minX, minY){
      /////////
      //SLOPE//
      /////////

      // Let n = the number of data points
      var n = data.length;

      // Get just the points
      var pts = [];
      data.forEach(function(d,i){
        var obj = {};
        obj.x = parseFloat(d[x]);
        obj.y = parseFloat(d[y]);
        obj.mult = obj.x*obj.y;
        if (obj.y > 0){
            pts.push(obj);
        }
      });
      // Let a equal n times the summation of all x-values multiplied by their corresponding y-values
      // Let b equal the sum of all x-values times the sum of all y-values
      // Let c equal n times the sum of all squared x-values
      // Let d equal the squared sum of all x-values
      var sum = 0;
      var xSum = 0;
      var ySum = 0;
      var sumSq = 0;
      pts.forEach(function(pt){
        sum = sum + pt.mult;
        xSum = xSum + pt.x;
        ySum = ySum + pt.y;
        sumSq = sumSq + (pt.x * pt.x);
      });
      var a = sum * n;
      var b = xSum * ySum;
      var c = sumSq * n;
      var d = xSum * xSum;

      // Plug the values that you calculated for a, b, c, and d into the following equation to calculate the slope
      // slope = m = (a - b) / (c - d)
      var m = (a - b) / (c - d);

      /////////////
      //INTERCEPT//
      /////////////

      // Let e equal the sum of all y-values
      var e = ySum;

      // Let f equal the slope times the sum of all x-values
      var f = m * xSum;

      // Plug the values you have calculated for e and f into the following equation for the y-intercept
      // y-intercept = b = (e - f) / n
      var b = (e - f) / n;

      // return an object of two points
      // each point is an object with an x and y coordinate
        var pt1 = [minX, m * minX + b];
        var pt2 = [(minY - b) / m, minY];
        
        var slope = (pt2[1] - pt1[1]) / (pt2[0] - pt1[0]);
        var xStart = 0;
        var yStart = pt1[1] + (xStart - pt1[0]) * slope;
        var start = [xStart, yStart];
        var xEnd = 50000;
        var yEnd = pt1[1] + (xEnd - pt1[0]) * slope;
        var end = [xEnd, yEnd];
        
       return {
        ptA : {
          x: start[0],
          y: start[1]
        },
        ptB : {
          x: end[0],
          y: end[1]
        }
      } 
        
    }
    </script>
</body>
</html>
